import type { Page } from "@playwright/test";
import { DetailsPageLayout } from "../DetailsPageLayout";
import { Navigation } from "../Navigation";
import { VulnerabilityListPage } from "../vulnerability-list/VulnerabilityListPage";
import { expect } from "../../assertions";

export class VulnerabilityDetailsPage {
  _layout: DetailsPageLayout;

  private constructor(_page: Page, layout: DetailsPageLayout) {
    this._layout = layout;
  }

  /**
   * Build the page object by navigating from the sidebar to the vulnerability list,
   * filtering, and clicking on the vulnerability link.
   */
  static async build(page: Page, vulnerabilityID: string) {
    const navigation = await Navigation.build(page);
    await navigation.goToSidebar("Vulnerabilities");

    const listPage = await VulnerabilityListPage.build(page);
    const toolbar = await listPage.getToolbar();
    const table = await listPage.getTable();

    await toolbar.applyFilter({ "Filter text": vulnerabilityID });
    await expect(table).toHaveColumnWithValue("ID", vulnerabilityID);

    await page
      .getByRole("link", { name: vulnerabilityID, exact: true })
      .click();

    const layout = await DetailsPageLayout.build(page);
    await layout.verifyPageHeader(vulnerabilityID);

    return new VulnerabilityDetailsPage(page, layout);
  }

  /**
   * Build the page object from the current page state WITHOUT navigating.
   * @param page - The Playwright page object
   * @param vulnerabilityID - Optional vulnerability ID to verify the page header
   */
  static async fromCurrentPage(page: Page, vulnerabilityID?: string) {
    const layout = await DetailsPageLayout.build(page);

    if (vulnerabilityID) {
      await layout.verifyPageHeader(vulnerabilityID);
    }

    return new VulnerabilityDetailsPage(page, layout);
  }
}
