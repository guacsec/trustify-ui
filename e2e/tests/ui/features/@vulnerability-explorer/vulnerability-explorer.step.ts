import { createBdd } from "playwright-bdd";

import { test } from "../../fixtures";

import { expect } from "../../assertions";

import { SearchPage } from "../../helpers/SearchPage";
import { ToolbarTable } from "../../helpers/ToolbarTable";

import { VulnerabilityDetailsPage } from "../../pages/vulnerability-details/VulnerabilityDetailsPage";
import { VulnerabilityListPage } from "../../pages/vulnerability-list/VulnerabilityListPage";
import { AdvisoriesTab } from "../../pages/vulnerability-details/advisories/AdvisoriesTab";
import { SbomsTab } from "../../pages/vulnerability-details/sboms/SbomsTab";

const SBOM_TABLE_NAME = "Sbom table";
const ADVISORY_TABLE_NAME = "Advisory table";

export const { Given, When, Then } = createBdd(test);

// Shared step - navigates to vulnerability details page
Given(
  "User visits Vulnerability details Page of {string}",
  async ({ page }, vulnerabilityID: string) => {
    await VulnerabilityDetailsPage.build(page, vulnerabilityID);
  },
);

// Vulnerability Search
When(
  "User searches for a vulnerability named {string} in the general search bar",
  async ({ page }, item) => {
    const searchPage = new SearchPage(page, "Dashboard");
    await searchPage.generalSearch("Vulnerabilities", item);
  },
);

When(
  "User searches for a vulnerability {string} in the dedicated search bar",
  async ({ page }, vulnerabilityID) => {
    const listPage = await VulnerabilityListPage.build(page);
    const toolbar = await listPage.getToolbar();
    await toolbar.applyFilter({ "Filter text": vulnerabilityID });
  },
);

Then(
  "The vulnerability {string} shows in the results",
  async ({ page }, vulnerabilityID) => {
    await expect(
      page.getByRole("gridcell").filter({ hasText: vulnerabilityID }),
    ).toBeVisible();
  },
);

// Vulnerability Explorer
Then(
  "The severity is {string} and the CVSS score is {string}",
  async ({ page }, severityDescription, severityScore) => {
    let severity: string | null = null;
    if (severityDescription === "Unknown") {
      severity = `${severityDescription}`;
    } else {
      severity = `${severityDescription}(${severityScore})`;
    }
    await expect(page.getByText(severity).first()).toBeVisible();
  },
);

Then(
  "The description begins with {string}",
  async ({ page }, descriptionBeginsWith) => {
    await expect(
      page.getByRole("paragraph").filter({ hasText: descriptionBeginsWith }),
    ).toBeVisible();
  },
);

Then(
  "The Reserved date is {string}, the Published date is {string} and Last modified date is {string}",
  async ({ page }, dateReserved, datePublished, dateLastModified) => {
    const reserved = `xpath=//dt[.="Reserved"]/following-sibling::dd[contains(.,"${dateReserved}")]`;
    const published = `xpath=//dt[.="Published"]/following-sibling::dd[contains(.,"${datePublished}")]`;
    const modified = `xpath=//dt[.="Modified"]/following-sibling::dd[contains(.,"${dateLastModified}")]`;
    await expect(page.locator(reserved)).toBeVisible();
    await expect(page.locator(published)).toBeVisible();
    await expect(page.locator(modified)).toBeVisible();
  },
);

// SBOMS

Then("The SBOMs table is sorted by {string}", async ({ page }, columnName) => {
  const sbomsTab = await SbomsTab.fromCurrentPage(page);
  const table = await sbomsTab.getTable();
  const columnHeader = await table.getColumnHeader(columnName);
  await expect(columnHeader).toHaveAttribute("aria-sort", "ascending");
});

Then(
  "The SBOMs table total results is {int}",
  async ({ page }, totalResults) => {
    const toolbarTable = new ToolbarTable(page, SBOM_TABLE_NAME);
    await toolbarTable.verifyPaginationHasTotalResults(totalResults);
  },
);

Then(
  "The SBOMs table total results is greather than {int}",
  async ({ page }, totalResults) => {
    const toolbarTable = new ToolbarTable(page, SBOM_TABLE_NAME);
    await toolbarTable.verifyPaginationHasTotalResultsGreatherThan(
      totalResults,
    );
  },
);

Then(
  "The {string} column of the SBOM table contains {string}",
  async ({ page }, columnName, expectedValue) => {
    const sbomsTab = await SbomsTab.fromCurrentPage(page);
    const table = await sbomsTab.getTable();
    await expect(table).toHaveColumnWithValue(columnName, expectedValue);
  },
);

// Advisories
Then(
  "User navigates to the Related Advisories tab on the Vulnerability Overview page",
  async ({ page }) => {
    const detailsPage = await VulnerabilityDetailsPage.fromCurrentPage(page);
    await detailsPage._layout.selectTab("Advisories");
  },
);

Then(
  "A list of all active Advisories tied to the Vulnerability should display",
  async ({ page }) => {
    const toolbarTable = new ToolbarTable(page, ADVISORY_TABLE_NAME);
    await toolbarTable.verifyPaginationHasTotalResultsGreatherThan(0);
  },
);

Then(
  "The {string} information should be visible for each advisory",
  async ({ page }, columnHeaders: string) => {
    const headers = columnHeaders
      .split(`,`)
      .map((column: string) => column.trim());

    for (const header of headers) {
      const columnHeader = page.getByRole("columnheader", { name: header });
      await expect(columnHeader).toBeVisible();
    }
  },
);

Then(
  "The advisories should be sorted by {string}",
  async ({ page }, columnName) => {
    const advisoriesTab = await AdvisoriesTab.fromCurrentPage(page);
    const table = await advisoriesTab.getTable();
    const columnHeader = await table.getColumnHeader(columnName);
    await expect(columnHeader).toHaveAttribute("aria-sort", "ascending");
  },
);

Then("User searches for {string}", async ({ page }, advisoryID) => {
  const advisoriesTab = await AdvisoriesTab.fromCurrentPage(page);
  const toolbar = await advisoriesTab.getToolbar();
  await toolbar.applyFilter({ "Filter text": advisoryID });
});

// Navigate to advisory details with type filter
Then(
  "User navigates to Advisory details Page of {string} with type {string}",
  async ({ page }, advisoryID, advisoryType) => {
    const table = await AdvisoriesTab.fromCurrentPage(page);
    const tableObj = await table.getTable();
    const rows = await tableObj.getRowsByCellValue({
      ID: advisoryID,
      Type: advisoryType,
    });
    await rows.getByRole("link", { name: advisoryID, exact: true }).click();
  },
);
