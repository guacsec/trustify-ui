import { expect, test } from "../fixtures";
import {
  testBasicSort,
  validateDateSorting,
  validateNumericSorting,
  validateSortDirectionDiffers,
} from "../helpers/sorting-helpers";

test.skip("Filter Vulnerabilities by severity - vanilla", async ({ axios }) => {
  // URLSearchParams ensures escaping special characters
  // Without URLSearchParams we would need to do something like:
  // axios.get("/api/v2/vulnerability?limit=10&offset=0&q=CVE-2023-2%26average_severity%3Dmedium%7Chigh&sort=published:asc")
  const queryParams = new URLSearchParams();
  queryParams.append("offset", "0");
  queryParams.append("limit", "10");
  queryParams.append("sort", "published:asc");
  queryParams.append("q", "CVE-2023-2&average_severity=medium|high");

  const serviceResponse = await axios.get("/api/v2/vulnerability", {
    params: queryParams,
  });

  expect(serviceResponse.data).toEqual(
    expect.objectContaining({
      total: 13,
    }),
  );
});

test.describe("Vulnerability sorting validation", () => {
  test("Sort vulnerabilities by ID ascending", async ({ axios }) => {
    await testBasicSort(axios, "/api/v2/vulnerability", "id", "asc");
  });

  test("Sort vulnerabilities by ID descending", async ({ axios }) => {
    await validateSortDirectionDiffers(
      axios,
      "/api/v2/vulnerability",
      "id",
      (item) => item.identifier,
    );
  });

  test("Sort vulnerabilities by CVSS score ascending", async ({ axios }) => {
    const items = await testBasicSort(
      axios,
      "/api/v2/vulnerability",
      "base_score",
      "asc",
    );
    validateNumericSorting(items, "average_score", "ascending");
  });

  test("Sort vulnerabilities by CVSS score descending", async ({ axios }) => {
    const items = await testBasicSort(
      axios,
      "/api/v2/vulnerability",
      "base_score",
      "desc",
    );
    validateNumericSorting(items, "average_score", "descending");
  });

  test("Sort vulnerabilities by published date ascending", async ({
    axios,
  }) => {
    const items = await testBasicSort(
      axios,
      "/api/v2/vulnerability",
      "published",
      "asc",
    );
    validateDateSorting(items, "published", "ascending");
  });

  test("Sort vulnerabilities by published date descending", async ({
    axios,
  }) => {
    const items = await testBasicSort(
      axios,
      "/api/v2/vulnerability",
      "published",
      "desc",
    );
    validateDateSorting(items, "published", "descending");
  });
});
