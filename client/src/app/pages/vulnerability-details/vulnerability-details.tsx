import React from "react";
import { Link } from "react-router-dom";

import {
  Breadcrumb,
  BreadcrumbItem,
  Content,
  Flex,
  FlexItem,
  PageSection,
  Tab,
  TabContent,
  TabTitleText,
  Tabs,
} from "@patternfly/react-core";
import spacing from "@patternfly/react-styles/css/utilities/Spacing/spacing";

import { PathParam, Paths, useRouteParams } from "@app/Routes";
import { extendedSeverityFromSeverity } from "@app/api/models";
import { LoadingWrapper } from "@app/components/LoadingWrapper";
import { SeverityShieldAndText } from "@app/components/SeverityShieldAndText";
import { useTabControls } from "@app/hooks/tab-controls";
import { useFetchVulnerabilityById } from "@app/queries/vulnerabilities";

import { AdvisoriesByVulnerability } from "./advisories-by-vulnerability";
import { Overview } from "./overview";
import { SbomsByVulnerability } from "./sboms-by-vulnerability";
import { DocumentMetadata } from "@app/components/DocumentMetadata";

export const VulnerabilityDetails: React.FC = () => {
  const vulnerabilityId = useRouteParams(PathParam.VULNERABILITY_ID);

  const { vulnerability, isFetching, fetchError } =
    useFetchVulnerabilityById(vulnerabilityId);

  // Tabs
  const {
    propHelpers: { getTabsProps, getTabProps, getTabContentProps },
  } = useTabControls({
    persistenceKeyPrefix: "vd", // vd="vulnerability details"
    persistTo: "urlParams",
    tabKeys: ["sboms", "advisories"],
  });

  const sbomsTabRef = React.createRef<HTMLElement>();
  const advisoriesTabRef = React.createRef<HTMLElement>();

  return (
    <>
      <DocumentMetadata title={vulnerability?.identifier} />
      <PageSection type="breadcrumb">
        <Breadcrumb>
          <BreadcrumbItem>
            <Link to={Paths.vulnerabilities}>Vulnerabilities</Link>
          </BreadcrumbItem>
          <BreadcrumbItem isActive>Vulnerability details</BreadcrumbItem>
        </Breadcrumb>
      </PageSection>
      <PageSection>
        <Flex>
          <FlexItem>
            <Content>
              <Content component="h1">
                {vulnerability?.identifier ?? ""}{" "}
              </Content>
            </Content>
          </FlexItem>
          <FlexItem>
            {vulnerability && (
              <SeverityShieldAndText
                value={extendedSeverityFromSeverity(
                  vulnerability.average_severity,
                )}
                score={vulnerability.average_score}
                showLabel
                showScore
              />
            )}
          </FlexItem>
        </Flex>
        <div className={spacing.mtSm}>
          <LoadingWrapper isFetching={isFetching} fetchError={fetchError}>
            {vulnerability && <Overview vulnerability={vulnerability} />}
          </LoadingWrapper>
        </div>
      </PageSection>
      <PageSection>
        <Tabs
          mountOnEnter
          {...getTabsProps()}
          aria-label="Vulnerability detail tabs"
          role="region"
        >
          <Tab
            {...getTabProps("sboms")}
            title={<TabTitleText>Related SBOMs</TabTitleText>}
            tabContentRef={sbomsTabRef}
          />
          <Tab
            {...getTabProps("advisories")}
            title={<TabTitleText>Related Advisories</TabTitleText>}
            tabContentRef={advisoriesTabRef}
          />
        </Tabs>
      </PageSection>
      <PageSection>
        <TabContent
          {...getTabContentProps("sboms")}
          ref={sbomsTabRef}
          aria-label="Related SBOMs"
        >
          <SbomsByVulnerability vulnerabilityId={vulnerabilityId} />
        </TabContent>
        <TabContent
          {...getTabContentProps("advisories")}
          ref={advisoriesTabRef}
          aria-label="Related Advisories"
        >
          <AdvisoriesByVulnerability
            isFetching={isFetching}
            fetchError={fetchError}
            advisories={vulnerability?.advisories || []}
          />
        </TabContent>
      </PageSection>
    </>
  );
};
