import React from "react";

import type { AxiosError } from "axios";

import {
  FILTER_NULL_VALUE,
  FILTER_TEXT_CATEGORY_KEY,
  TablePersistenceKeyPrefixes,
} from "@app/Constants";
import type { VulnerabilitySummary } from "@app/client";
import { FilterType } from "@app/components/FilterToolbar";
import {
  type ITableControls,
  getHubRequestParams,
  useTableControlProps,
  useTableControlState,
} from "@app/hooks/table-controls";
import { useFetchVulnerabilities } from "@app/queries/vulnerabilities";
import { parseBooleanIfPossible } from "@app/utils/utils";

export interface IVulnerabilitySearchContext {
  tableControls: ITableControls<
    VulnerabilitySummary,
    "identifier" | "title" | "severity" | "published" | "sboms",
    "identifier" | "published" | "severity",
    "" | "base_severity" | "published" | "publishedOnly",
    string
  >;

  totalItemCount: number;
  isFetching: boolean;
  fetchError: AxiosError | null;
}

const contextDefaultValue = {} as IVulnerabilitySearchContext;

export const VulnerabilitySearchContext =
  React.createContext<IVulnerabilitySearchContext>(contextDefaultValue);

interface IVulnerabilityProvider {
  children: React.ReactNode;
}

export const VulnerabilitySearchProvider: React.FunctionComponent<
  IVulnerabilityProvider
> = ({ children }) => {
  const tableControlState = useTableControlState({
    tableName: "vulnerability",
    persistenceKeyPrefix: TablePersistenceKeyPrefixes.vulnerabilities,
    persistTo: "urlParams",
    columnNames: {
      identifier: "ID",
      title: "Description",
      severity: "CVSS",
      published: "Published",
      sboms: "Impacted SBOMs",
    },
    isPaginationEnabled: true,
    isSortEnabled: true,
    sortableColumns: ["identifier", "published", "severity"],
    initialSort: {
      columnKey: "published",
      direction: "desc",
    },
    isFilterEnabled: true,
    filterCategories: [
      {
        categoryKey: FILTER_TEXT_CATEGORY_KEY,
        title: "Filter text",
        placeholderText: "Search",
        type: FilterType.search,
      },
      {
        categoryKey: "base_severity",
        title: "CVSS",
        placeholderText: "CVSS",
        type: FilterType.multiselect,
        selectOptions: [
          { value: FILTER_NULL_VALUE, label: "Unknown" },
          { value: "none", label: "None" },
          { value: "low", label: "Low" },
          { value: "medium", label: "Medium" },
          { value: "high", label: "High" },
          { value: "critical", label: "Critical" },
        ],
      },
      {
        categoryKey: "published",
        title: "Published",
        type: FilterType.dateRange,
      },
      {
        categoryKey: "publishedOnly",
        title: "Published only",
        type: FilterType.toggle,
        label: "Published only",
        serverFilterField: "published",
        getServerFilterValue: () => [FILTER_NULL_VALUE],
        getOperator: (filterValue) => {
          return parseBooleanIfPossible(filterValue?.[0]) ? "=" : "!=";
        },
        showOutsideDropdown: true,
      },
    ],
    isExpansionEnabled: true,
    expandableVariant: "compound",
  });

  const {
    result: { data: vulnerabilities, total: totalItemCount },
    isFetching,
    fetchError,
  } = useFetchVulnerabilities(
    getHubRequestParams({
      ...tableControlState,
      hubSortFieldKeys: {
        identifier: "id",
        severity: "base_score",
        published: "published",
      },
    }),
  );

  const tableControls = useTableControlProps({
    ...tableControlState,
    idProperty: "identifier",
    currentPageItems: vulnerabilities,
    totalItemCount,
    isLoading: isFetching,
  });

  return (
    <VulnerabilitySearchContext.Provider
      value={{ totalItemCount, isFetching, fetchError, tableControls }}
    >
      {children}
    </VulnerabilitySearchContext.Provider>
  );
};
